# before.yml
# install Linux platform dependencies & set environment variables

parameters:
  # store all the downloaded files
  dependenciesDir: "$(Agent.BuildDirectory)/tmp"
  # directory to download the JDK used to bootstrap the build
  jdkBootDir: "$(Agent.BuildDirectory)/jdk/boot"
  # store jdk used for gradle
  javaHomeDir: "$(Agent.BuildDirectory)/jdk/home"

steps:
  # create all required directories before downloading files & installing jdks
  - bash: |
      mkdir -p ${{ parameters.jdkBootDir }}
      mkdir -p ${{ parameters.javaHomeDir }}
      mkdir -p ${{ parameters.dependenciesDir }}
    displayName: "[Linux Before] create required directories"

  # based on
  # https://github.com/AdoptOpenJDK/openjdk-infrastructure/blob/master/ansible/playbooks/AdoptOpenJDK_Unix_Playbook/roles/Common/vars/MacOSX.yml
  - bash: |
      sleep 15
      sudo apt-get install autoconf ccache coreutils
    displayName: "[Linux Before] apt-get install autoconf, ccache, coreutils"

  # download JDKs from AdoptOpenJDK
  - bash: |
      wget -O "${{ parameters.dependenciesDir }}/openjdk8.tar.gz" "https://api.adoptopenjdk.net/v3/binary/latest/8/ga/mac/x64/jdk/hotspot/normal/adoptopenjdk?project=jdk"
      if [ "${BOOTJDK_VERSION}" == "15" ]
      then
          wget -O "${{ parameters.dependenciesDir }}/openjdk.tar.gz" "https://api.adoptopenjdk.net/v3/binary/latest/${BOOTJDK_VERSION}/ea/mac/x64/jdk/hotspot/normal/adoptopenjdk?project=jdk"
      else
          wget -O "${{ parameters.dependenciesDir }}/openjdk.tar.gz" "https://api.adoptopenjdk.net/v3/binary/latest/${BOOTJDK_VERSION}/ga/mac/x64/jdk/hotspot/normal/adoptopenjdk?project=jdk"
      fi
    displayName: "[Linux Before] download JDKs from AdoptOpenJDK"

  # untar downloaded JDK files & move it to directories
  - bash: |
      tar -xzf "${{ parameters.dependenciesDir }}/openjdk8.tar.gz" --strip-components=3 -C ${{ parameters.javaHomeDir }}
      tar -xzf "${{ parameters.dependenciesDir }}/openjdk.tar.gz" --strip-components=3 -C ${{ parameters.jdkBootDir }}
    displayName: "[Linux Before] extracting downloaded JDKs to directories"

  # set system veraibles that will be used by following steps
  - bash: |
      echo "##vso[task.setvariable variable=JDK_BOOT_DIR]${{ parameters.jdkBootDir }}"
      echo "##vso[task.setvariable variable=JAVA_HOME]${{ parameters.javaHomeDir }}"
      echo "##vso[task.setvariable variable=PATH]${{ parameters.jdkBootDir }}/bin;$PATH"
    displayName: "[Linux Before] set JDK_BOOT_DIR, JAVA_HOME, and PATH environment variables"
