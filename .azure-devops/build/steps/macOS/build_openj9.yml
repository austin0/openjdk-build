# build_openj9.yml
# run the ./makejdk-any-platform.sh and upload generated files to artifacts

steps:
  # using the AdoptOpenJDK build scripts to build the OpenJDK binaries
  - bash: |
      if [ "$(JAVA_TO_BUILD)" == "jdk" ]
      then
          CONFIG_ARGS="--enable-dtrace"
      elif [ "$(JAVA_TO_BUILD)" == "jdk15u" ]
      then
          CONFIG_ARGS="--enable-dtrace"
      elif [ "$(JAVA_TO_BUILD)" == "jdk14u" ]
      then
          CONFIG_ARGS="--enable-dtrace=auto"
      elif [ "$(JAVA_TO_BUILD)" == "jdk11u" ]
      then
          CONFIG_ARGS="--enable-dtrace=auto"
      fi

      echo "Getting freemarker==========================================="
      wget http://apache.mirror.anlx.net/freemarker/engine/2.3.30/binaries/apache-freemarker-2.3.30-bin.tar.gz -O freemarker.tar.gz
      tar -xzf freemarker.tar.gz
      CONFIGURE_ARGS="--with-freemarker-jar=$(pwd)/apache-freemarker-2.3.30-bin/freemarker.jar ${CONFIGURE_ARGS}"
      echo "Got freemarker==============================================="

      echo "Getting nasm================================================="
      wget https://www.nasm.us/pub/nasm/releasebuilds/2.15.05rc2/nasm-2.15.05rc2.tar.gz -O nasm.tar.gz
      tar -xzf nasm.tar.gz
      echo "Installing nasm=============================================="
      cd $(pwd)/nasm-2.15.05rc2
      ./configure --prefix=/usr && make
      make install
      export PATH="/cygdrive/c/NASM:$PATH"
      export PATH="$(pwd)/NASM:$PATH"
      echo "Installed nasm==============================================="
      cd ..
      
      ./makejdk-any-platform.sh \
        ${EXTRA_MAKEJDK_ANY_PLATFORM_OPTIONS} \
        --jdk-boot-dir "${JDK_BOOT_DIR}" \
        --configure-args "${CONFIG_ARGS} --disable-warnings-as-errors --with-extra-cxxflags='-mmacosx-version-min=10.9'" \
        --destination artifacts \
        --target-file-name "${FILENAME}.tar.gz" \
        --use-jep319-certs \
        --build-variant "openj9" \
        $(JAVA_TO_BUILD)
    displayName: "[macOS Build] start makejdk-any-platform process"

  # upload the produced JDK/JRE binary to the build artifact service
  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: $(Agent.OS)_$(ARCHITECTURE)
      targetPath: "$(Build.SourcesDirectory)/workspace/artifacts"
    displayName: "[macOS Build] upload JKD/JRE artifact"
